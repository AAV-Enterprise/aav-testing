name: OWASP ZAP Full Scan
on:
  workflow_call:
    inputs: {}
  pull_request:
  push:
    branches: ["main"]

env:
  COMPOSE_PROJECT_NAME: demoapp

jobs:
  sast_semgrep:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Semgrep (SAST)
        uses: semgrep/semgrep-action@v1
        with:
          config: p/owasp-top-ten

  secrets_gitleaks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Gitleaks (Secrets Scan)
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  container_trivy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build images (docker compose)
        run: docker compose build

      # IMPORTANT: imaginile rezultate vor fi demoapp_backend:latest și demoapp_frontend:latest
      - name: Trivy scan backend image (MEDIUM+)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: demoapp_backend:latest
          format: table
          exit-code: 1
          ignore-unfixed: true
          severity: MEDIUM,HIGH,CRITICAL

      - name: Trivy scan frontend image (MEDIUM+)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: demoapp_frontend:latest
          format: table
          exit-code: 1
          ignore-unfixed: true
          severity: MEDIUM,HIGH,CRITICAL

  zap_scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Instalare Docker Compose
        run: sudo apt-get update && sudo apt-get install -y docker-compose
      - name: Build & Start servicii Docker
        run: docker-compose up -d --build
      - name: Așteaptă pornirea serviciilor
        run: |
          for i in `seq 1 60`; do
            curl -fsS http://localhost:3000/api/posts >/dev/null 2>&1 && break
            echo "Așteaptă backend..."
            sleep 2
          done
          for i in `seq 1 60`; do
            curl -fsS http://localhost:8080/ >/dev/null 2>&1 && break
            echo "Așteaptă frontend..."
            sleep 2
          done
          # IMPORTANT: pagina statică pentru ZAP seeds
          for i in `seq 1 30`; do
            curl -fsS http://localhost:8080/zap.html >/dev/null 2>&1 && break
            echo "Așteaptă /zap.html..."
            sleep 2
          done
      - name: Rulare OWASP ZAP Full Scan (bounded & seeded)
        uses: zaproxy/action-full-scan@v0.13.0
        with:
          target: 'http://localhost:8080/'
          cmd_options: '-m 2 -T 5'
          fail_action: true
          allow_issue_writing: false
          rules_file_name: '.zap/rules.tsv'
      - name: Oprire și curățare servicii
        if: always()
        run: docker-compose down -v
