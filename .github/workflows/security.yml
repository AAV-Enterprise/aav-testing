name: OWASP ZAP Full Scan

on:
  workflow_call:
    inputs: {}

jobs:
  Secrets-Gitleaks:
    name: Secrets (Gitleaks)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout caller repo
        uses: actions/checkout@v4

      - name: Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  Trivy:
    name: Container Scan
    runs-on: ubuntu-latest
    outputs:
      backend_high: ${{ steps.trivy_counts.outputs.backend_high }}
      frontend_high: ${{ steps.trivy_counts.outputs.frontend_high }}
    env:
      COMPOSE_PROJECT_NAME: demoapp
    steps:
      - name: Checkout caller repo
        uses: actions/checkout@v4

      - name: Build images
        run: docker compose build

      - name: Trivy backend (report only)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: demoapp_backend:latest
          format: json
          output: trivy-backend.json
          exit-code: 0
          ignore-unfixed: true
          severity: MEDIUM,HIGH,CRITICAL

      - name: Trivy frontend (report only)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: demoapp_frontend:latest
          format: json
          output: trivy-frontend.json
          exit-code: 0
          ignore-unfixed: true
          severity: MEDIUM,HIGH,CRITICAL

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Count HIGH+ (backend/frontend)
        id: trivy_counts
        run: |
          backend_high=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH" or .Severity=="CRITICAL")] | length' trivy-backend.json)
          frontend_high=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH" or .Severity=="CRITICAL")] | length' trivy-frontend.json)
          echo "backend_high=$backend_high" >> $GITHUB_OUTPUT
          echo "frontend_high=$frontend_high" >> $GITHUB_OUTPUT
          echo "Trivy backend HIGH+ = $backend_high"
          echo "Trivy frontend HIGH+ = $frontend_high"

  SAST:
    runs-on: ubuntu-latest
    outputs:
      high_count: ${{ steps.semgrep_counts.outputs.high_count }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Semgrep
        run: python3 -m pip install semgrep

      - name: Semgrep scan (report only)
        run: semgrep --config p/owasp-top-ten --json -o semgrep.json . || true

      - name: Count Semgrep findings
        id: semgrep_counts
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          high=$(jq '[.results[]? | select(.extra.severity=="ERROR")] | length' semgrep.json)
          echo "high_count=$high" >> $GITHUB_OUTPUT
          echo "Semgrep ERROR findings = $high"

  SCA:
    name: SCA (npm audit)
    runs-on: ubuntu-latest
    needs: [SAST]
    outputs:
      backend_high: ${{ steps.audit_counts.outputs.backend_high }}
      frontend_high: ${{ steps.audit_counts.outputs.frontend_high }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Backend - npm ci
        working-directory: backend
        run: npm ci

      - name: Frontend - npm ci
        working-directory: frontend
        run: npm ci

      - name: Backend - npm audit (json)
        working-directory: backend
        run: |
          npm audit --json > audit-backend.json || true

      - name: Frontend - npm audit (json)
        working-directory: frontend
        run: |
          npm audit --json > audit-frontend.json || true

      - name: Count HIGH/CRITICAL from npm audit
        id: audit_counts
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          backend_high=$(jq '[.. | objects | select(has("severity")) | select(.severity=="high" or .severity=="critical")] | length' backend/audit-backend.json)
          frontend_high=$(jq '[.. | objects | select(has("severity")) | select(.severity=="high" or .severity=="critical")] | length' frontend/audit-frontend.json)
          echo "backend_high=$backend_high" >> $GITHUB_OUTPUT
          echo "frontend_high=$frontend_high" >> $GITHUB_OUTPUT
          echo "npm audit backend HIGH+ = $backend_high"
          echo "npm audit frontend HIGH+ = $frontend_high"

      - name: Upload npm audit reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-reports
          path: |
            backend/audit-backend.json
            frontend/audit-frontend.jso

  Zap-Scan:
    runs-on: ubuntu-latest
    outputs:
      zap_high: ${{ steps.zap_counts.outputs.zap_high }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Installing Docker Compose
        run: sudo apt-get update && sudo apt-get install -y docker-compose
      - name: Build & Start Docker services
        run: docker-compose up -d --build
      - name: Waiting services
        run: |
          for i in `seq 1 60`; do
            curl -fsS http://localhost:3000/api/posts >/dev/null 2>&1 && break
            echo "Waiting backend..."
            sleep 2
          done
          for i in `seq 1 60`; do
            curl -fsS http://localhost:8080/ >/dev/null 2>&1 && break
            echo "Waiting frontend..."
            sleep 2
          done
          for i in `seq 1 30`; do
            curl -fsS http://localhost:8080/zap.html >/dev/null 2>&1 && break
            echo "Waiting /zap.html..."
            sleep 2
          done
      - name: Run OWASP ZAP Full Scan (bounded & seeded)
        uses: zaproxy/action-full-scan@v0.13.0
        with:
          target: 'http://localhost:8080/search-share?q=test'
          cmd_options: >
            -j
            -m 5
            -T 300
          rules_file_name: '.zap/rules.tsv'
          allow_issue_writing: false
      # - name: Fail if HIGH alerts exist
      #   run: |
      #     test -f report_json.json || (echo "Missing report_json.json" && ls -la && exit 2)
      #     count=$(jq '[.site[].alerts[] | select((.riskcode|tonumber) > 2)] | length' report_json.json)
      #     echo "ZAP alerts HIGH+ = $count"
      #     if [ "$count" -gt 0 ]; then
      #       echo "Failing: found HIGH alerts"
      #       exit 1
      #     fi
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Count ZAP HIGH
        id: zap_counts
        run: |
          count=$(jq '[.site[].alerts[] | select((.riskcode|tonumber) > 2)] | length' report_json.json)
          echo "zap_high=$count" >> $GITHUB_OUTPUT
          echo "ZAP HIGH = $count"
      - name: Stop and clean-up
        if: always()
        run: docker-compose down -v

  Final-Gate:
    name: Final Gate (fail at end)
    runs-on: ubuntu-latest
    needs: [Secrets-Gitleaks, Trivy, SAST, SCA, Zap-Scan]
    if: always()
    steps:
      - name: Decide final result (HIGH only)
        run: |
          trivy_backend_high=${{ needs.Trivy.outputs.backend_high }}
          trivy_frontend_high=${{ needs.Trivy.outputs.frontend_high }}
          semgrep_high=${{ needs.SAST.outputs.high_count }}
          zap_high=${{ needs.Zap-Scan.outputs.zap_high }}

          echo "Trivy backend HIGH+  = $trivy_backend_high"
          echo "Trivy frontend HIGH+ = $trivy_frontend_high"
          echo "Semgrep ERROR        = $semgrep_high"
          echo "ZAP HIGH             = $zap_high"

          total=$((trivy_backend_high + trivy_frontend_high + semgrep_high + zap_high))
          echo "TOTAL blocking (HIGH policy) = $total"

          if [ "$total" -gt 0 ]; then
            echo "Failing at end (policy: HIGH only)"
            exit 1
          fi