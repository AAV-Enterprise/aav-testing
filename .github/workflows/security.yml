name: OWASP ZAP Full Scan

on:
  workflow_call:
    inputs: {}

jobs:
  SAST:
    name: SAST (Semgrep)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout caller repo
        uses: actions/checkout@v4

      - name: Semgrep
        uses: semgrep/semgrep-action@v1
        with:
          config: p/owasp-top-ten

  Secrets-Gitleaks:
    name: Secrets (Gitleaks)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout caller repo
        uses: actions/checkout@v4

      - name: Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  Trivy:
    name: Container Scan
    runs-on: ubuntu-latest
    env:
      COMPOSE_PROJECT_NAME: demoapp
    steps:
      - name: Checkout caller repo
        uses: actions/checkout@v4

      - name: Build images
        run: docker compose build

      - name: Trivy backend
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: demoapp_backend:latest
          format: table
          exit-code: 1
          ignore-unfixed: true
          severity: MEDIUM,HIGH,CRITICAL

      - name: Trivy frontend
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: demoapp_frontend:latest
          format: table
          exit-code: 1
          ignore-unfixed: true
          severity: MEDIUM,HIGH,CRITICAL

  SCA:
    name: SCA (OSV-Scanner)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout caller repo
        uses: actions/checkout@v4

      - name: Run OSV-Scanner
        uses: google/osv-scanner-action@v1.7.1
        with:
          scan-args: |-
            --recursive
            ./backend
            ./frontend

  Zap-Scan:
    runs-on: ubuntu-latest
    needs: [SAST, Secrets-Gitleaks, Trivy, SCA]
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Installing Docker Compose
        run: sudo apt-get update && sudo apt-get install -y docker-compose
      - name: Build & Start Docker services
        run: docker-compose up -d --build
      - name: Waiting services
        run: |
          for i in `seq 1 60`; do
            curl -fsS http://localhost:3000/api/posts >/dev/null 2>&1 && break
            echo "Waiting backend..."
            sleep 2
          done
          for i in `seq 1 60`; do
            curl -fsS http://localhost:8080/ >/dev/null 2>&1 && break
            echo "Waiting frontend..."
            sleep 2
          done
          for i in `seq 1 30`; do
            curl -fsS http://localhost:8080/zap.html >/dev/null 2>&1 && break
            echo "Waiting /zap.html..."
            sleep 2
          done
      - name: Run OWASP ZAP Full Scan (bounded & seeded)
        uses: zaproxy/action-full-scan@v0.13.0
        with:
          target: 'http://localhost:8080/search-share?q=test'
          cmd_options: >
            -j
            -m 5
            -T 300
          rules_file_name: '.zap/rules.tsv'
          allow_issue_writing: false
      - name: Fail if HIGH alerts exist
        run: |
          test -f report_json.json || (echo "Missing report_json.json" && ls -la && exit 2)
          count=$(jq '[.site[].alerts[] | select((.riskcode|tonumber) > 2)] | length' report_json.json)
          echo "ZAP alerts HIGH+ = $count"
          if [ "$count" -gt 0 ]; then
            echo "Failing: found HIGH alerts"
            exit 1
          fi
      - name: Stop and clean-up
        if: always()
        run: docker-compose down -v