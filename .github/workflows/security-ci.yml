name: Security CI (Reusable)

on:
  workflow_call:
    inputs:
      run_gitleaks:
        type: boolean
        default: true
      run_semgrep:
        type: boolean
        default: true
      run_trivy_fs:
        type: boolean
        default: true
      run_trivy_image:
        type: boolean
        default: false
      trivy_severity:
        type: string
        default: "HIGH,CRITICAL"
      image_ref:
        type: string
        required: false

      run_dast_zap:
        type: boolean
        default: false
      run_dast_zap_active:
        type: boolean
        default: false
      zap_target:
        type: string
        default: "http://127.0.0.1:8080"

permissions:
  contents: read
  packages: read

jobs:
  gitleaks:
    if: ${{ inputs.run_gitleaks }}
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure reports folder
        run: mkdir -p reports

      - name: Gitleaks scan (JSON)
        shell: bash
        run: |
          docker run --rm \
            -v "${PWD}:/repo" \
            zricethezav/gitleaks:latest detect \
              --source="/repo" \
              --no-git \
              --redact \
              --report-format json \
              --report-path "/repo/reports/gitleaks.json" || true

      - name: Ensure report exists
        if: always()
        run: |
          [ -f reports/gitleaks.json ] || echo "{}" > reports/gitleaks.json

      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: reports/gitleaks.json
          if-no-files-found: warn

  semgrep:
    if: ${{ inputs.run_semgrep }}
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Ensure reports folder
        run: mkdir -p reports

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Semgrep
        shell: bash
        run: |
          python -m pip install --upgrade pip
          pip install semgrep
          semgrep --version

      - name: Semgrep scan (JSON)
        shell: bash
        run: |
          semgrep scan --config p/default --json -o reports/semgrep.json . || true

      - name: Ensure report exists
        if: always()
        run: |
          [ -f reports/semgrep.json ] || echo "{}" > reports/semgrep.json

      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-report
          path: reports/semgrep.json
          if-no-files-found: warn

  trivy_fs:
    if: ${{ inputs.run_trivy_fs }}
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Ensure reports folder
        run: mkdir -p reports

      - name: Trivy filesystem scan (JSON)
        shell: bash
        run: |
          docker run --rm \
            -v "${PWD}:/work" \
            -w /work \
            aquasec/trivy:latest fs \
              --scanners vuln,secret,misconfig \
              --severity "${{ inputs.trivy_severity }}" \
              --format json \
              --output reports/trivy-fs.json \
              /work || true

      - name: Ensure report exists
        if: always()
        run: |
          [ -f reports/trivy-fs.json ] || echo "{}" > reports/trivy-fs.json

      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-fs-report
          path: reports/trivy-fs.json
          if-no-files-found: warn

  trivy_image:
    if: ${{ inputs.run_trivy_image }}
    runs-on: self-hosted
    steps:
      - name: Ensure reports folder
        run: mkdir -p reports

      - name: Validate image_ref
        shell: bash
        run: |
          if [ -z "${{ inputs.image_ref }}" ]; then
            echo "image_ref is required when run_trivy_image=true"
            exit 2
          fi

      - name: Log in to GHCR
        shell: bash
        run: |
          echo "${{ github.token }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Pull image
        run: docker pull "${{ inputs.image_ref }}"

      - name: Trivy image scan (JSON)
        shell: bash
        run: |
          docker run --rm \
            -v "${PWD}:/work" \
            -w /work \
            aquasec/trivy:latest image \
              --severity "${{ inputs.trivy_severity }}" \
              --format json \
              --output reports/trivy-image.json \
              "${{ inputs.image_ref }}" || true

      - name: Ensure report exists
        if: always()
        run: |
          [ -f reports/trivy-image.json ] || echo "{}" > reports/trivy-image.json

      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-image-report
          path: reports/trivy-image.json
          if-no-files-found: warn

  dast_zap:
    if: ${{ inputs.run_dast_zap || inputs.run_dast_zap_active }}
    runs-on: self-hosted
    timeout-minutes: 40
    steps:
      - uses: actions/checkout@v4

      - name: Docker access check
        shell: bash
        run: |
          set -euo pipefail
          id
          docker info

      - name: Ensure reports folder
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p reports
          echo "sentinel $(date -Is)" > reports/_sentinel.txt
          ls -la reports

      - name: Start app via docker compose
        shell: bash
        run: |
          set -euo pipefail
          export COMPOSE_PROJECT_NAME="demoapp_${{ github.run_id }}_${{ github.run_attempt }}"
          docker compose -f docker-compose.ci.yml up -d --build
          docker compose -f docker-compose.ci.yml ps

      - name: Wait for app health
        shell: bash
        run: |
          set -euo pipefail
          URL="${{ inputs.zap_target }}/health"
          for i in $(seq 1 90); do
            code="$(curl -s -o /tmp/health_body.txt -w "%{http_code}" "$URL" || true)"
            if [ "$code" = "200" ]; then
              echo "App is healthy"
              exit 0
            fi
            sleep 2
          done
          docker compose -f docker-compose.ci.yml logs --no-color --tail=300 || true
          exit 1





      - name: ZAP Baseline (passive)
        if: ${{ inputs.run_dast_zap }}
        shell: bash
        env:
          HTTP_PROXY: ""
          HTTPS_PROXY: ""
          ALL_PROXY: ""
          NO_PROXY: "127.0.0.1,localhost"
          http_proxy: ""
          https_proxy: ""
          all_proxy: ""
          no_proxy: "127.0.0.1,localhost"
        run: |
          set -euo pipefail
          docker run --rm \
            --network host \
            -v "${PWD}:/zap/wrk" \
            zaproxy/zap-stable \
            zap-baseline.py \
              -t "${{ inputs.zap_target }}" \
              -I -s \
              -r reports/zap-baseline.html \
              -J reports/zap-baseline.json || true

           - name: ZAP Baseline (passive)
        if: ${{ inputs.run_dast_zap }}
        shell: bash
        env:
          HTTP_PROXY: ""
          HTTPS_PROXY: ""
          ALL_PROXY: ""
          NO_PROXY: "127.0.0.1,localhost"
          http_proxy: ""
          https_proxy: ""
          all_proxy: ""
          no_proxy: "127.0.0.1,localhost"
        run: |
          set -euo pipefail
          docker run --rm \
            --network host \
            -v "${PWD}:/zap/wrk" \
            zaproxy/zap-stable \
            zap-baseline.py \
              -t "${{ inputs.zap_target }}" \
              -I -s \
              -r reports/zap-baseline.html \
              -J reports/zap-baseline.json || true

      - name: ZAP Active (full scan)
        if: ${{ inputs.run_dast_zap_active }}
        shell: bash
        env:
          HTTP_PROXY: ""
          HTTPS_PROXY: ""
          ALL_PROXY: ""
          NO_PROXY: "127.0.0.1,localhost"
          http_proxy: ""
          https_proxy: ""
          all_proxy: ""
          no_proxy: "127.0.0.1,localhost"
        run: |
          set -euo pipefail
          docker run --rm \
            --network host \
            -v "${PWD}:/zap/wrk" \
            zaproxy/zap-stable \
            zap-full-scan.py \
              -t "${{ inputs.zap_target }}" \
              -a -j \
              -r reports/zap-active.html \
              -J reports/zap-active.json || true






      - name: Ensure ZAP report files exist
        if: always()
        shell: bash
        run: |
          mkdir -p reports
          [ -f reports/zap-baseline.html ] || echo "<html><body>No baseline report generated</body></html>" > reports/zap-baseline.html
          [ -f reports/zap-baseline.json ] || echo "{}" > reports/zap-baseline.json
          [ -f reports/zap-active.html ] || echo "<html><body>No active report generated</body></html>" > reports/zap-active.html
          [ -f reports/zap-active.json ] || echo "{}" > reports/zap-active.json
          ls -la reports

      - name: Upload ZAP reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-reports
          path: reports/
          if-no-files-found: error

      - name: Tear down
        if: always()
        shell: bash
        run: |
          export COMPOSE_PROJECT_NAME="demoapp_${{ github.run_id }}_${{ github.run_attempt }}"
          docker compose -f docker-compose.ci.yml down -v --remove-orphans || true
