name: Security CI (Reusable)

on:
  workflow_call:
    inputs:
      run_gitleaks:
        type: boolean
        default: true
      run_semgrep:
        type: boolean
        default: true
      run_trivy_fs:
        type: boolean
        default: true
      run_trivy_image:
        type: boolean
        default: false

      trivy_severity:
        type: string
        default: "HIGH,CRITICAL"

      image_ref:
        type: string
        required: false

      run_dast_zap:
        type: boolean
        default: false


permissions:
  contents: read
  packages: read

jobs:
  gitleaks:
    if: ${{ inputs.run_gitleaks }}
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure reports folder
        run: mkdir -p reports

      - name: Gitleaks scan (JSON)
        run: |
          docker run --rm \
            -v "${PWD}:/repo" \
            zricethezav/gitleaks:latest detect \
              --source="/repo" \
              --no-git \
              --redact \
              --report-format json \
              --report-path "/repo/reports/gitleaks.json" || true

      - name: Upload Gitleaks report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: reports/gitleaks.json

  semgrep:
    if: ${{ inputs.run_semgrep }}
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure reports folder
        run: mkdir -p reports

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Semgrep
        run: |
          python -m pip install --upgrade pip
          pip install semgrep
          semgrep --version

      - name: Semgrep scan (JSON)
        run: |
          semgrep scan --config p/default --json -o reports/semgrep.json . || true

      - name: Upload Semgrep report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-report
          path: reports/semgrep.json

  trivy_fs:
    if: ${{ inputs.run_trivy_fs }}
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure reports folder
        run: mkdir -p reports

      - name: Trivy filesystem scan (JSON)
        run: |
          docker run --rm \
            -v "${PWD}:/work" \
            -w /work \
            aquasec/trivy:latest fs \
              --scanners vuln,secret,misconfig \
              --severity "${{ inputs.trivy_severity }}" \
              --format json \
              --output reports/trivy-fs.json \
              /work || true

      - name: Upload Trivy FS report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-fs-report
          path: reports/trivy-fs.json

  trivy_image:
    if: ${{ inputs.run_trivy_image }}
    runs-on: self-hosted
    steps:
      - name: Ensure reports folder
        run: mkdir -p reports

      - name: Validate image_ref
        run: |
          if [ -z "${{ inputs.image_ref }}" ]; then
            echo "image_ref is required when run_trivy_image=true"
            exit 2
          fi

      - name: Log in to GHCR
        run: |
          echo "${{ github.token }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Pull image
        run: docker pull "${{ inputs.image_ref }}"

      - name: Trivy image scan (JSON)
        run: |
          docker run --rm \
            -v "${PWD}:/work" \
            -w /work \
            aquasec/trivy:latest image \
              --severity "${{ inputs.trivy_severity }}" \
              --format json \
              --output reports/trivy-image.json \
              "${{ inputs.image_ref }}" || true

      - name: Upload Trivy Image report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-image-report
          path: reports/trivy-image.json

  dast_zap:
    if: ${{ inputs.run_dast_zap }}
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start application (docker-compose)
        run: |
          docker compose -f docker-compose.ci.yml up -d
          sleep 10

      - name: ZAP Baseline Scan
        run: |
          docker run --rm \
            --network host \
            -v "${PWD}:/zap/wrk" \
            zaproxy/zap-stable \
            zap-baseline.py \
              -t http://localhost:8080 \
              -r zap-report.html || true

      - name: Upload ZAP report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: zap-report.html
