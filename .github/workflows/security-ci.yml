name: Security CI (Reusable)

on:
  workflow_call:
    inputs:
      run_gitleaks:
        type: boolean
        default: true
      run_semgrep:
        type: boolean
        default: true
      run_trivy_fs:
        type: boolean
        default: true
      run_trivy_image:
        type: boolean
        default: false
      trivy_severity:
        type: string
        default: "HIGH,CRITICAL"
      image_ref:
        type: string
        required: false

      run_dast_zap:
        type: boolean
        default: false
      run_dast_zap_active:
        type: boolean
        default: false

      # IMPORTANT: scan via docker-compose network, not host localhost
      zap_target:
        type: string
        default: "http://app:8080"

permissions:
  contents: read
  packages: read

jobs:
  gitleaks:
    if: ${{ inputs.run_gitleaks }}
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure reports folder
        run: mkdir -p reports

      - name: Gitleaks scan (JSON)
        shell: bash
        run: |
          docker run --rm \
            -v "${PWD}:/repo" \
            zricethezav/gitleaks:latest detect \
              --source="/repo" \
              --no-git \
              --redact \
              --report-format json \
              --report-path "/repo/reports/gitleaks.json" || true

      - name: Ensure report exists
        if: always()
        run: |
          [ -f reports/gitleaks.json ] || echo "{}" > reports/gitleaks.json

      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: reports/gitleaks.json
          if-no-files-found: warn

  semgrep:
    if: ${{ inputs.run_semgrep }}
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Ensure reports folder
        run: mkdir -p reports

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Semgrep
        shell: bash
        run: |
          python -m pip install --upgrade pip
          pip install semgrep
          semgrep --version

      - name: Semgrep scan (JSON)
        shell: bash
        run: |
          semgrep scan --config p/default --json -o reports/semgrep.json . || true

      - name: Ensure report exists
        if: always()
        run: |
          [ -f reports/semgrep.json ] || echo "{}" > reports/semgrep.json

      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-report
          path: reports/semgrep.json
          if-no-files-found: warn

  trivy_fs:
    if: ${{ inputs.run_trivy_fs }}
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Ensure reports folder
        run: mkdir -p reports

      - name: Trivy filesystem scan (JSON)
        shell: bash
        run: |
          docker run --rm \
            -v "${PWD}:/work" \
            -w /work \
            aquasec/trivy:latest fs \
              --scanners vuln,secret,misconfig \
              --severity "${{ inputs.trivy_severity }}" \
              --format json \
              --output reports/trivy-fs.json \
              /work || true

      - name: Ensure report exists
        if: always()
        run: |
          [ -f reports/trivy-fs.json ] || echo "{}" > reports/trivy-fs.json

      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-fs-report
          path: reports/trivy-fs.json
          if-no-files-found: warn

  trivy_image:
    if: ${{ inputs.run_trivy_image }}
    runs-on: self-hosted
    steps:
      - name: Ensure reports folder
        run: mkdir -p reports

      - name: Validate image_ref
        shell: bash
        run: |
          if [ -z "${{ inputs.image_ref }}" ]; then
            echo "image_ref is required when run_trivy_image=true"
            exit 2
          fi

      - name: Log in to GHCR
        shell: bash
        run: |
          echo "${{ github.token }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Pull image
        run: docker pull "${{ inputs.image_ref }}"

      - name: Trivy image scan (JSON)
        shell: bash
        run: |
          docker run --rm \
            -v "${PWD}:/work" \
            -w /work \
            aquasec/trivy:latest image \
              --severity "${{ inputs.trivy_severity }}" \
              --format json \
              --output reports/trivy-image.json \
              "${{ inputs.image_ref }}" || true

      - name: Ensure report exists
        if: always()
        run: |
          [ -f reports/trivy-image.json ] || echo "{}" > reports/trivy-image.json

      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-image-report
          path: reports/trivy-image.json
          if-no-files-found: warn

  dast_zap:
  if: ${{ inputs.run_dast_zap || inputs.run_dast_zap_active }}
  runs-on: self-hosted
  timeout-minutes: 45
  steps:
    - uses: actions/checkout@v4

    - name: Ensure reports folder
      shell: bash
      run: |
        set -euo pipefail
        mkdir -p reports
        echo "sentinel $(date -Is)" > reports/_sentinel.txt

    - name: Start app via docker compose
      shell: bash
      run: |
        set -euo pipefail
        export COMPOSE_PROJECT_NAME="demoapp_${{ github.run_id }}_${{ github.run_attempt }}"
        docker compose -f docker-compose.ci.yml up -d --build
        docker compose -f docker-compose.ci.yml ps

    - name: Detect compose network
      shell: bash
      run: |
        set -euo pipefail
        export COMPOSE_PROJECT_NAME="demoapp_${{ github.run_id }}_${{ github.run_attempt }}"
        NET="${COMPOSE_PROJECT_NAME}_default"
        echo "COMPOSE_NET=${NET}" >> "$GITHUB_ENV"
        docker network ls | grep -F "$NET" || (echo "Network $NET not found" && exit 1)

    - name: Wait for app health (inside compose network)
      shell: bash
      run: |
        set -euo pipefail
        for i in $(seq 1 90); do
          if docker run --rm --network "${COMPOSE_NET}" curlimages/curl:8.5.0 -fsS "http://app:8080/health" >/dev/null 2>&1; then
            echo "App is healthy"
            exit 0
          fi
          sleep 2
        done
        docker compose -f docker-compose.ci.yml logs --no-color --tail=300 || true
        exit 1

    - name: Run ZAP baseline (authenticated) via Automation Framework
      if: ${{ inputs.run_dast_zap }}
      shell: bash
      run: |
        set -euo pipefail
        docker run --rm \
          --network "${COMPOSE_NET}" \
          -v "${PWD}:/zap/wrk:rw" \
          -w /zap/wrk \
          zaproxy/zap-stable \
          bash -lc '
            chmod +x zap/run_zap_baseline.sh
            ./zap/run_zap_baseline.sh
          ' || true

    - name: Run ZAP full (authenticated) via Automation Framework
      if: ${{ inputs.run_dast_zap_active }}
      shell: bash
      run: |
        set -euo pipefail
        docker run --rm \
          --network "${COMPOSE_NET}" \
          -v "${PWD}:/zap/wrk:rw" \
          -w /zap/wrk \
          zaproxy/zap-stable \
          bash -lc '
            chmod +x zap/run_zap_full.sh
            ./zap/run_zap_full.sh
          '

    - name: Upload ZAP reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: zap-reports
        path: reports/
        if-no-files-found: warn

    - name: Tear down
      if: always()
      shell: bash
      run: |
        export COMPOSE_PROJECT_NAME="demoapp_${{ github.run_id }}_${{ github.run_attempt }}"
        docker compose -f docker-compose.ci.yml down -v --remove-orphans || true

